<!--
Versione semplificata
‚Ä¢ I contenuti PRIVATI sono VISIBILI di default.
‚Ä¢ Se non c‚Äô√® token ‚ûú nasconde privato e mostra CTA.
‚Ä¢ Se token c‚Äô√® ‚ûú chiama AuthSystem.verifyToken().
   ‚Äì valido   ‚ûú lascia tutto visibile, aggiunge banner.
   ‚Äì non valido ‚ûú redirect a accesso‚Äënegato.
Cos√¨ evitiamo dipendenze da funzioni globali di auth.js che potrebbero mancare.
-->
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Il Re ‚Äì Messaggio Quotidiano | Scacchi Mentali</title>
  <meta name="description" content="Messaggio quotidiano personalizzato per l'archetipo del Re.">

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='18' font-size='18'>‚ôî</text></svg>">

  <!-- Font & CSS principali -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/style.css">

  <!-- Stili minimi aggiuntivi -->
  <style>
    :root { --archetipo-color: var(--color-re); }
    body   { margin:0; font-family:'Montserrat',sans-serif; }
    .access-banner{position:fixed;top:0;left:0;right:0;padding:15px;text-align:center;font-weight:600;font-size:15px;z-index:9999}
    .access-banner.public{background:#444;color:#fff}
    .access-banner.private{background:linear-gradient(45deg,#FFD700,#FFA500);color:#000}
    /* CTA quiz */
    .quiz-cta{max-width:700px;margin:40px auto;background:linear-gradient(135deg,#1a1a1a,#2a2a2a);padding:30px;border:2px solid #FFD700;border-radius:15px;text-align:center}
    .quiz-cta h3{color:#FFD700;margin:0 0 15px}
    .quiz-cta p{color:#ccc;margin:0 0 20px}
    .quiz-cta a{display:inline-block;background:linear-gradient(45deg,#FFD700,#FFA500);color:#000;padding:12px 24px;border-radius:25px;font-weight:700;text-decoration:none}
  </style>

  <!-- auth.js che espone AuthSystem.verifyToken -->
  <script defer src="/js/auth.js"></script>
</head>
<body>
  <!-- HEADER sintetico -->
  <header style="background:#111;color:#fff;padding:20px 0;text-align:center">
    <a href="../../index.html"><img src="../../images/logo.png" alt="Logo" style="height:40px"></a>
    <h1 style="margin:10px 0 0;font-size:24px">Scacchi Mentali</h1>
  </header>

  <!-- HERO -->
  <section style="padding:60px 0;text-align:center;background:radial-gradient(circle at center,#2a2215 0%,#000 100%)">
    <div style="font-size:6rem;color:var(--archetipo-color);text-shadow:0 0 20px rgba(255,215,0,.5)">‚ôî</div>
    <h2 style="font-size:2.5rem;margin:0.5rem 0;color:#fff">Il Re</h2>
    <p style="color:#bbb;margin:0 0 20px;letter-spacing:1px">LEADER STRATEGICO ¬∑ PROTETTORE ¬∑ SAGGIO</p>
    <div style="display:inline-block;background:#222;color:#ddd;padding:6px 18px;border-radius:20px;font-size:14px">
      <span id="today">Caricamento‚Ä¶</span>
    </div>
  </section>

  <!-- MESSAGGIO QUOTIDIANO (PRIVATO DI DEFAULT VISIBILE) -->
  <main id="private-wrapper">
    <section style="padding:40px 20px">
      <div style="max-width:700px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.1);border-top:4px solid var(--archetipo-color)">
        <div style="display:flex;align-items:center;padding:22px">
          <h3 style="flex:1;margin:0;font-size:1.8rem">Il Tuo Messaggio di Oggi</h3>
          <img src="../../images/archetipi/re.png" alt="Il Re" style="width:60px">
        </div>
        <div style="padding:0 22px 22px;line-height:1.6;font-size:1rem">
          <p id="daily-msg">¬´Oggi, come un vero Re, ricorda che la tua forza non risiede nel dominare, ma nel proteggere‚Ä¶¬ª</p>
        </div>
        <div style="padding:0 22px 30px;display:flex;gap:10px">
          <button id="share-btn" style="flex:1;background:linear-gradient(135deg,var(--archetipo-color),#FFB000);border:none;border-radius:8px;padding:12px;font-weight:600;cursor:pointer">üì§ Condividi</button>
          <button id="save-btn"  style="flex:1;background:#eee;border:none;border-radius:8px;padding:12px;cursor:pointer">üíæ Salva</button>
        </div>
      </div>
    </section>

    <!-- CTA subscription -->
    <section style="text-align:center;padding:30px 0">
      <h3>Vuoi ricevere messaggi quotidiani personalizzati?</h3>
      <p>Attiva la tua subscription mensile e non perdere mai un giorno di crescita strategica.</p>
      <a href="../../subscribe/?archetipo=re" style="background:linear-gradient(45deg,#FFD700,#FFA500);color:#000;padding:12px 24px;border-radius:25px;font-weight:700;text-decoration:none">üëë Attiva Subscription</a>
    </section>
  </main>

  <!-- CTA QUIZ (inserita via JS se pubblico) -->
  <div id="public-container"></div>

  <!-- FOOTER minimo -->
  <footer style="background:#111;color:#666;text-align:center;padding:30px 0;font-size:14px">¬© 2025 Scacchi Mentali</footer>

  <!-- JS Sistema Autenticazione -->
  <script>
  // Imposta data corrente
  document.getElementById('today').textContent = new Date().toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

  // Funzione per caricare messaggi giornalieri
  async function loadDailyMessage() {
    try {
      const response = await fetch('../../messages/re-messages.json');
      const messages = await response.json();
      
      // Data di oggi in formato YYYY-MM-DD
      const today = new Date().toISOString().split('T')[0];
      
      // Cerca messaggio per oggi
      if (messages[today]) {
        document.getElementById('daily-msg').textContent = messages[today];
      } else {
        // Messaggio di fallback
        document.getElementById('daily-msg').textContent = 'Oggi, come un vero Re, ricorda che la tua forza non risiede nel dominare, ma nel proteggere. Ogni decisione che prendi dovrebbe riflettere la saggezza di chi ha visto molte battaglie.';
      }
    } catch (error) {
      console.error('Errore caricamento messaggio:', error);
    }
  }

  // Parametri URL
  const params = new URLSearchParams(location.search);
  const token = params.get('token');
  const sections = document.getElementById('private-wrapper');
  const publicBox = document.getElementById('public-container');

  // Banner di accesso
  function addBanner(type, text) {
    const banner = document.createElement('div');
    banner.className = 'access-banner ' + type;
    banner.textContent = text;
    banner.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; padding: 15px; text-align: center; 
      font-weight: 600; font-size: 15px; z-index: 9999;
      ${type === 'private' ? 'background: linear-gradient(45deg,#FFD700,#FFA500); color: #000;' : 'background: #444; color: #fff;'}
    `;
    document.body.appendChild(banner);
    document.body.style.paddingTop = '60px';
  }

  // Contenuto pubblico (senza token)
  function showPublicContent() {
    sections.style.display = 'none';
    addBanner('public', 'üëÅÔ∏è Contenuto limitato ‚Äì completa il quiz per sbloccare');
    publicBox.innerHTML = `
      <div class="quiz-cta">
        <h3>üß† Vuoi accedere ai messaggi completi?</h3>
        <p>Completa il quiz gratuito per scoprire il tuo archetipo.</p>
        <a href="/">üéØ Inizia il Quiz</a>
      </div>
    `;
  }

  // Contenuto privato (token valido)
  function showPrivateContent(userInfo) {
    addBanner('private', 'üîí Accesso Privato Autorizzato');
    
    // Carica messaggio giornaliero
    loadDailyMessage();
    
    // Abilita funzioni share/save
    const msgElement = document.getElementById('daily-msg');
    
    document.getElementById('share-btn').onclick = async () => {
      const text = msgElement.textContent;
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Messaggio del Re',
            text: text,
            url: location.href
          });
        } catch (e) {
          console.log('Share cancelled');
        }
      } else {
        await navigator.clipboard.writeText(`${text}\n${location.href}`);
        alert('Messaggio copiato negli appunti!');
      }
    };
    
    document.getElementById('save-btn').onclick = () => {
      const text = msgElement.textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'messaggio_il_re.txt';
      a.click();
    };
  }

  // Controllo accesso principale
  async function checkAccess() {
    if (!token) {
      // Nessun token = accesso pubblico
      showPublicContent();
      return;
    }

    try {
      // Estrai archetipo dall'URL
      const pathParts = location.pathname.split('/').filter(Boolean);
      const archetipoIndex = pathParts.indexOf('archetipi');
      const archetipo = archetipoIndex > -1 ? pathParts[archetipoIndex + 1] : 're';

      // Verifica token usando AuthSystem globale
      if (window.AuthSystem && window.AuthSystem.verifyToken) {
        const result = await window.AuthSystem.verifyToken(token, archetipo);
        
        if (result.valid) {
          showPrivateContent(result.userInfo);
        } else {
          // Token non valido - redirect a pagina errore
          location.href = `/chess-whispers-arcane/accesso-negato.html?error=${encodeURIComponent(result.error || 'Token non valido')}`;
        }
      } else {
        throw new Error('Sistema autenticazione non disponibile');
      }
    } catch (error) {
      console.error('Errore autenticazione:', error);
      location.href = `/chess-whispers-arcane/accesso-negato.html?error=${encodeURIComponent('Errore di connessione')}`;
    }
  }

  // Avvia controllo accesso quando AuthSystem √® disponibile
  function initPage() {
    if (window.AuthSystem) {
      checkAccess();
    } else {
      // Riprova dopo un breve delay
      setTimeout(initPage, 100);
    }
  }

  // Avvia inizializzazione
  initPage();
  </script>
</body>
</html>
