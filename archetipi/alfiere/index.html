<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L'Alfiere – Messaggio Quotidiano | Scacchi Mentali</title>
  <meta name="description" content="Messaggio quotidiano personalizzato per l'archetipo dell'Alfiere: visione strategica e creatività.">

  <!-- Favicon "♗" -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><text y='18' font-size='18'>♗</text></svg>">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Stili globali -->
  <link rel="stylesheet" href="../../css/style.css">

  <!-- Stili specifici "Alfiere" -->
  <style>
    :root{--archetipo-color:var(--color-alfiere);}
    .archetipo-hero{background:radial-gradient(circle at center,#331c09 0%,var(--color-background) 100%);}
    .archetipo-icon{color:var(--color-alfiere);text-shadow:0 0 20px rgba(255,69,0,.5);}
    .message-card{border-top:4px solid var(--color-alfiere);}
    .action-button.primary{background:linear-gradient(135deg,var(--color-alfiere),#FF6347);}

    /* banner auth */
    .access-notice{position:fixed;top:0;left:0;right:0;z-index:10000;padding:15px;text-align:center;font-weight:700;font-size:16px;}
    .access-notice.private{background:linear-gradient(45deg,#FF4500,#FF6347);color:#fff;border-bottom:3px solid #FF4500;}
    .access-notice.public {background:linear-gradient(45deg,#666,#888);color:#fff;border-bottom:3px solid #666;}

    /* messaggio limitato */
    .message-content.limited{opacity:.6;font-style:italic;background:rgba(255,255,255,.05);padding:20px;border-radius:10px;border:2px dashed rgba(255,255,255,.2);text-align:center;}

    /* CTA quiz */
    .quiz-cta{background:linear-gradient(135deg,#1a1a1a,#2a2a2a);border:2px solid #FF4500;border-radius:15px;padding:30px;margin:30px auto;max-width:700px;text-align:center;}
    .quiz-cta h3{color:#FF4500;margin-bottom:15px;}
    .quiz-cta p {color:#ccc;margin-bottom:20px;}
    .quiz-cta a {display:inline-block;background:linear-gradient(45deg,#FF4500,#FF6347);color:#fff;padding:12px 24px;border-radius:25px;font-weight:700;text-decoration:none;}

    /* di default i contenuti privati non sono visibili */
    .private-content{display:none;}
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header">
    <div class="container" style="padding:15px 0;text-align:center;">
      <a href="../../index.html"><img src="../../images/logo.png" alt="Scacchi Mentali" style="height:40px;"></a>
      <h1 style="margin-top:10px;font-weight:600;">Scacchi Mentali</h1>
    </div>
  </header>

  <!-- HERO -->
  <section class="archetipo-hero hero">
    <div class="container">
      <div class="hero-content">
        <div class="archetipo-icon" style="font-size: 4rem; margin-bottom: 20px;">♗</div>
        <h1 class="hero-title">L'Alfiere</h1>
        <p class="archetipo-subtitle">Visionario • Creativo • Strategico</p>
        <div class="current-date">
          <span id="current-date">Caricamento…</span>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA PUBBLICA -->
  <div id="public-cta-container"></div>

  <!-- MESSAGGIO QUOTIDIANO (privato) -->
  <section class="messaggio-quotidiano private-content">
    <div class="container">
      <div class="message-card">
        <div class="message-header">
          <h2>Il Tuo Messaggio di Oggi</h2>
          <img src="../../images/archetipi/alfiere.png" alt="L'Alfiere" class="archetipo-image">
        </div>
        <div class="message-content">
          <p id="daily-message" class="daily-message">Caricamento del messaggio…</p>
        </div>
        <div class="message-actions">
          <button id="share-button" class="action-button primary" disabled>📤 Condividi Messaggio</button>
          <button id="save-button"  class="action-button secondary" disabled>💾 Salva Messaggio</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SUBSCRIPTION CTA (privata) -->
  <section class="subscription-cta private-content">
    <div class="container" style="text-align:center;padding:30px 0;">
      <a href="../../subscribe/?archetipo=alfiere" class="cta-button" style="background:linear-gradient(45deg,#FF4500,#FF6347);color:#fff;padding:12px 24px;border-radius:20px;font-weight:bold;text-decoration:none;">
        🔥 Vai alla pagina Subscription per L'Alfiere
      </a>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container" style="padding:20px 0;text-align:center;color:#777;">
      <p>&copy; 2025 Scacchi Mentali. Tutti i diritti riservati.</p>
      <div style="margin-top:10px;">
        <a href="../../index.html" style="margin:0 8px;">Home</a>
        <a href="#privacy"          style="margin:0 8px;">Privacy</a>
        <a href="#termini"          style="margin:0 8px;">Termini</a>
      </div>
    </div>
  </footer>

  <!-- SCRIPT AUTENTICAZIONE + LOGICA UI -->
  <script>
  /* -------------------- CONFIG -------------------- */
  const WEB_APP_URL   = 'https://script.google.com/macros/s/AKfycbweYcCMsWIaHb6TpZzY4-Tk5NcwzM4WNAZBsEKd92mxY6inWuq9h1Bm3r3szdEqL9nthg/exec';
  const ERROR_PAGE    = 'https://antoca84.github.io/chess-whispers-arcane/accesso-negato.html';
  const ARCHETIPO     = 'alfiere';

  /* -------------------- UTILITY UI -------------------- */
  function addBanner(type,msg){
    const b=document.createElement('div');
    b.className=`access-notice ${type}`; b.textContent=msg;
    document.body.prepend(b); document.body.style.paddingTop='60px';
  }
  function showQuizCTA(){
    document.getElementById('public-cta-container').innerHTML=
      `<div class="quiz-cta">
         <h3>🧠 Vuoi accedere ai messaggi completi?</h3>
         <p>Se non l'hai già fatto completa il quiz gratuito per scoprire il tuo archetipo e sbloccare contenuti personalizzati.</p>
         <a href="../../index.html">🎯 Inizia il Quiz Gratuito</a>
       </div>`;
  }
  function showPrivateSections(){
    document.querySelectorAll('.private-content').forEach(el=>el.style.display='block');
    document.getElementById('share-button').disabled=false;
    document.getElementById('save-button').disabled=false;
  }
  function hidePrivateSections(){
    document.querySelectorAll('.private-content').forEach(el=>el.style.display='none');
  }

  /* -------------------- TOKEN FLOW -------------------- */
  async function verifyToken(token){
    try{
      const r = await fetch(`${WEB_APP_URL}?action=verify&token=${encodeURIComponent(token)}&archetipo=${ARCHETIPO}`);
      if(!r.ok) return {valid:false};
      return await r.json();
    }catch(e){
      console.error(e); return {valid:false};
    }
  }

  async function handleAuth(){
    // data corrente
    document.getElementById('current-date').textContent =
      new Date().toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

    const params = new URLSearchParams(window.location.search);
    const token  = params.get('token');

    if(!token){
      addBanner('public','👁️ Contenuto Limitato – nessun token presente');
      hidePrivateSections(); showQuizCTA(); return;
    }

    addBanner('public','⏳ Verifica token in corso…');
    const res = await verifyToken(token);
    document.querySelector('.access-notice').remove();   // remove loading

    if(res && res.valid){
      addBanner('private',`🔒 Accesso Privato Autorizzato – ${ARCHETIPO.toUpperCase()}`);
      showPrivateSections(); loadDailyMessage(); enableActions();
    }else{
      window.location.href = `${ERROR_PAGE}?error=${encodeURIComponent(res.error || 'Token non valido')}`;
    }
  }

  /* -------------------- MESSAGGI -------------------- */
  async function loadDailyMessage(){
    try{
      const r = await fetch('../../messages/alfiere-messages.json');
      const data = await r.json();
      const today = new Date().toISOString().split('T')[0];
      const msg = data[today] || 'Messaggio non disponibile per oggi.';
      document.getElementById('daily-message').textContent = msg;
      window._currentMsg = msg; // per share/save
    }catch(e){
      document.getElementById('daily-message').textContent = 'Errore nel caricamento del messaggio.';
    }
  }

  /* -------------------- AZIONI SHARE / SAVE -------------------- */
  function enableActions(){
    const shareBtn=document.getElementById('share-button');
    const saveBtn =document.getElementById('save-button');

    shareBtn.onclick=async()=>{
      const text=window._currentMsg+'\n\nScacchi Mentali';
      if(navigator.share){ try{await navigator.share({title:'Messaggio dell\'Alfiere',text, url:location.href});}catch{} }
      else{ try{await navigator.clipboard.writeText(text); alert('Messaggio copiato negli appunti!');}catch{} }
    };

    saveBtn.onclick=()=>{
      const blob=new Blob([window._currentMsg],{type:'text/plain'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`messaggio-alfiere-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    };
  }

  document.addEventListener('DOMContentLoaded',handleAuth);
  </script>
</body>
</html>